<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Thing Description Playground - Validate your W3C Thing Description</title>
		<link rel="shortcut icon" type="image/x-icon" href="favlogo.png" />
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="css/playground.css" />
		<script type="text/javascript" src="js/node_modules/jsonld/dist/jsonld.js"></script>
		<script type="text/javascript" src="js/ajv.min.js"></script> <!--JSON Schema validator-->
		<script type="text/javascript" src="js/UTILS/helperFunctions.js"></script>
		<script type="text/javascript" src="js/UTILS/commonFunctions.js"></script>
		<script type="text/javascript" src="js/jquery-2.2.3.js"></script>
		<script type="text/javascript" src="js/jquery-linedtextarea.js"></script>
		<script type="text/javascript" src="js/playground.js"></script>
		<script type="text/javascript" src="js/papaparse.min.js"></script> <!--CSV to JSON parser library-->
		<script src="js/monaco/min/vs/loader.js"></script>
	</head>

	<body>
		<div  id="assertion_test_popup" class="curtain" style="display: none; background-color: rgba(0, 0, 0, 0.8) ;" >
			<div class="assertion-test-popup "  >
				<button class="btn top-right" id="close_assertion_test_popup">X</button>
				<div >Please Select the manual assertions options.</div>
					
				<table class="table table-striped" style="display:block; height : 80%;overflow-y : scroll;" >
					
					<thead class="thead-dark">
						<tr>
						<th scope="col" style="padding-left: 1em;">#</th>
						<th scope="col" style="padding-left: 1em;">Assertion ID</th>
						<th scope="col" style="padding-right: 8em;">Status</th>
						<th scope="col" style="padding-left: 1em;">Description</th>
						</tr>
					</thead>
					
					<tbody id="manual_assertion_table_body"  >
						<!--Manual assertions will be appended here dynamically-->
					</tbody>
						
				</table>
				
				<button type="button" class="btn" id="btn_assertion">Assertion Test</button>
			</div>
		</div>

		<div id="curtain" class="curtain">
			<div id="curtain-text">Loading Environment. Please wait....</div><img src="loading.svg" style="  position: fixed; bottom: 45%; left: 35%;width:30%;height:30%;opacity: 0.3;filter: alpha(opacity=30);" alt="Loading..." />
		</div>

		<div class="container-fluid" style="padding-top:0px">
			
			<div class="row alert alert-info" style="padding:0px">
				<div class="col-2">
					<div>
						<img alt="Thingweb Logo" src="logo.png"  style="float: left; height:3em; padding-top:1em">
					</div>
				</div>

				<div class="col-6">
						<h3 style="display: inline;">Thing Description Playground</h3><br>
						
							<a href="https://w3c.github.io/wot-thing-description/#" target="_blank">TD Validation According to the W3C Thing Description Recommendation</a>
				</div>

				<div class="col-4">
						<nav class="navbar navbar-dark bg-info">
							<a class="navbar-brand btn" href="https://github.com/thingweb/thingweb-playground/issues/new">Create Issue</a>
							<a class="navbar-brand btn" href="https://github.com/thingweb/thingweb-playground/tree/master/Scripts">Script Validation </a>
						</nav>
					</div>
			</div>

			<div class="wrapper">
				<div class="row" style="min-height: 500px;">
					<div class="col-8"> 
						<div id="monaco" style="height: 500px; width: auto;">
						</div>
					</div>
					
					<div class="col-4">
						<font size="2" face="Arial" >
							<div class="panel">	
								<div class="row">
									<table class="table">
										<tr  id="validation_table_head" class="btn-info">
											<th  rowspan="2"> &nbsp<i id="table_head_arrow" class="down"></i>&nbsp</th>
											<tbody id="validation_table">
												<td >
													<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
														<circle id="spot-json" cx="10" cy="10" r="9" />
													</svg>
												</td>
												<td title="Is green when TD is a valid JSON">JSON validation</td>
											</tr>
											<tr>
												<td >
													<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
														<circle id="spot-simple-json-schema" cx="10" cy="10" r="9" />
													</svg>
												</td>
												<td title="Is green when TD is valid according to the JSON Schema of the TD spec">JSON Schema validation</td>
											</tr>
											<tr>
												<td>
													<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
														<circle id="spot-full-json-schema" cx="10" cy="10" r="9" />
													</svg>
												</td>
												<td
													title="Optional: Is green when the validated TD has no default assumptions and everything is explicitly declared">
													(With Defaults) JSON Schema validation</td>
											</tr>
											<tr>
											<tr>
												<td>
													<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
														<circle id="spot-json-ld" cx="10" cy="10" r="9" />
													</svg>
												</td>
												<td title="Is green when TD can be expanded using the @context value">JSON-LD validation
												</td>
											</tr>
											<tr>
												<td>
													<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
														<circle id="spot-add" cx="10" cy="10" r="9" />
													</svg>
												</td>
												<td title="Is green when all custom checks pass">Additional Checks</td>
											</tr>
										</tbody>
									</table>
								</div>
								
								<div class="row">
									<form >
										<div class="form-group">
											<label for="editor_theme">Editor Theme  </label>
											<select  id="editor_theme" class="btn btn-info dropdown-toggle btn-sm" style="height: 1qem;">							
												<option class="btn-info" value="vs">White </option>
												<option class="btn-info" value="vs-dark">Dark </option>
												<option class="btn-info" value="hc-black">Contrast </option>
											</select>
											&nbsp;&nbsp;
											<input   type="checkbox"  id="box_auto_validate" value="off"> Auto Validate
												
											<br>
											<div class="btn-group" role="group">
												<button   type="button" class="btn" id="btn_validate">Validate</button>
												<button   type="button" class="btn" id="btn_clearLog" >Clear Log</button>
											</div>
											<br>
											<div class="btn-group" role="group">
												<!-- <button type="button" class="btn" id="btn_gistify" title="Stores the current TD as a gist at Thingweb">Gistify</button> -->
												<button type="button" class="btn" id="btn_assertion_popup">Assertion Test</button>
											</div>
											
										</div>
										
									</form>
								</div>

								<div class="row">
									<form>
										<div class="form-group">
											<label>Examples:</label>					
											<select id="load_example" class="btn btn-info btn-sm dropdown-toggle">
												<option class="btn-info" value="select_none">Select None </option>
											</select>
										</div>
									</form>
								</div>

							</div>
						</font>				
					</div>
				</div>

				<div class="row" style="max-height:250px;overflow-y:scroll;">
					<div class="col">
							<pre id="console" >Waiting for validation...&#13;&#10;</pre>
					</div>
					
				</div>
				<div id="offline-warning"> </div>
			</div>
			
			<div class="push"></div>
		
		</div>

		<footer>
			<div class="footer-shape">
				<img src="footer-shape.jpg" width="100%" height="50px">
			</div>
			<div class="links">
				<ul>
					<li>
						<a href="http://www.eclipse.org/">Eclipse Foundation</a>
					</li>
					<li>|</li>
					<li>
						<a href="http://www.eclipse.org/legal/privacy.php">Privacy policy</a>
					</li>
					<li>|</li>
					<li>
						<a href="http://www.eclipse.org/legal/termsofuse.php">Terms of use</a>
					</li>
					<li>|</li>
					<li>
						<a href="http://www.eclipse.org/legal/copyright.php">Copyright</a>
					</li>
					<li>|</li>
					<li>
						<a href="http://www.eclipse.org/legal">Legal</a>
					</li>
				</ul>
				<p>Copyrights Â© 2020 Eclipse Thingweb. All Rights Reserved.<p>
			</div>
		</footer>
	</body>
</html>

<script>

var manualAssertions = [];
var results = [];

$(document).ready(function(){

	if(browserName()!="Firefox")// Shows warning if the Browser is other than Firefox
		{
			$( "#offline-warning" ).append("<b> Warning:</b> Browsers other than Firefox present will not work for offline validation due to CORS policy.<br>");
		}

  	// when table is extracted
	$("#validation_table").fadeOut("fast",function(){
		$("#table_head_arrow").removeClass();
        $("#table_head_arrow").toggleClass("down");
	}); 

	$("#validation_table_head").click(toggleValidationStatusTable);// Toggles Validation Table view
	$("#box_auto_validate").change(function(){ // Auto validates only when the box is checked.
		autoValidate=$("#box_auto_validate").prop("checked");

	});
	
	$("#btn_assertion_popup").click(function(event){//show assertion test popup
		event.preventDefault();

		$.ajax({
			type: "GET",
			url: "manual.csv",
			dataType: "text",
			success: function(data) {fetchManualAssertions(data);}
		});

		/* 
			For the given CSV data of assertions, it parses them uses Papa library 
			and pushes them as JSON objects in an array
		*/
		function fetchManualAssertions(allText) {
			manualAssertions=[]
			var assertionData = Papa.parse(allText).data;
			for (let index = 1; index < assertionData.length; index++) { //1 and not 0 since the 0th is the header
				var element = assertionData[index];
				var singleAssertionJSON = {"ID":element[0],"Status":element[1],"Comment":element[2],"Description":element[3]};
				manualAssertions.push(singleAssertionJSON);
			}

			$.each( manualAssertions, function( i, assertion ) {
				var htmlrow = 
					"<td style=\"padding-left: 1em;\">" + i + "</td>" +
					"<input type='hidden' value="+i+">"+
					"<td style=\"padding-left: 1em;\">" + assertion.ID + "</td>" +
					"<td>"+
					"<input type='radio' value='null' name='status"+i+"'/>null"+
					"<input type='radio' value='not-impl' name='status"+i+"'/>not-impl"+
					"<input type='radio' value='impl' name='status"+i+"'/>impl"+
					"<td style=\"padding-left: 1em;\">" + assertion.Description + "</td>" ;
				$("<tr/> </table>").html(htmlrow).appendTo("#manual_assertion_table_body");
				$('input:radio[name=status'+i+"]")[0].checked = true;

			});
		
			$('input[type="radio"]').on('change', function() {
				indexnum= $(this).parent().parent().find("input[type=hidden]").first().val()
				manualAssertions[indexnum]["Status"]=$(this).val()
			});
		}

		$("#assertion_test_popup").css("display","block");
	});

	$("#close_assertion_test_popup").click(function(event){//close assertion test popup
		event.preventDefault();
		$("#assertion_test_popup").css("display","none");
	})

	let urlAddrObject= getExamplesList(); //Fetching list of examples from the given array(in helperFunctions.js). 
	populateExamples(urlAddrObject);     // Loading the examples given in list from their respective URLs

	$("#load_example").change({urlAddrObject:urlAddrObject},exampleSelectHandler);// attaching handler to the drop down menu of the examples list.
	
	$("#editor_theme").change(function(event){window.monaco.editor.setTheme($("#editor_theme").val())})
	
	$("#btn_assertion").click(performAssertionTest);// attaching function to the assertion button, the function performs Assertion test

	$("#btn_validate").click({source:"manual"},validate);// attaching Function to the Validate(Manual) Button.

	$("#btn_gistify").click(submitAsGist);// Attaching Function to Gistify Button, The functions handles submitting TD as Gist.

	$("#btn_clearLog").click(clearLog); // Clear logs
		
	$("#td-text").keydown(textAreaManipulation);// Text area manipulation

//**************************Monaco editor code*********************************////		
	require.config({ paths: { 'vs': 'js/monaco/min/vs' }});
	require(['vs/editor/editor.main'], editor=function() {
	
		var jsonCode = [].join('\n'); //Temporary initial Json
		var modelUri = monaco.Uri.parse("a://b/foo.json"); // a made up unique URI for our model
		var model = monaco.editor.createModel(jsonCode, "json", modelUri);

		$.getJSON("td-schema.json",function(json){
			var td_schema=json;

			// configure the JSON language support with schemas and schema associations
			monaco.languages.json.jsonDefaults.setDiagnosticsOptions({
				validate: true,
				//schemas: [schema] // List of schemas to validate against, It will validate the TD with in the editor area.
				schemas:[{
					fileMatch: [modelUri.toString()], // associate with our model
					schema:td_schema 
				}
				]
			});

			window.editor=monaco.editor.create(document.getElementById("monaco"), {
				model: model,
				contextmenu: false,
				theme:"vs"
			});

			$("#curtain").css("display","none")

			model.onDidChangeContent((event) => { // When text in the Editor changes
				validate(event,"auto");
			});
		});
	});
});

</script>